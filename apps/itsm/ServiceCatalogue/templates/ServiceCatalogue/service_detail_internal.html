{% extends "ServiceCatalogue/services_base.html" %}

{% load i18n %}
{% load text_filters %}

{% block title %}{{ sr.service.name }} - {{ sr.key }} ({% translate "Internal" %}){% endblock %}

{% block bodycontent %}
<div class="container-fluid px-0">
  <!-- Print styles -->
  <style media="print">
    @page {
      size: A4;
      margin: 1.5cm;
    }
    .no-print {
      display: none !important;
    }
    .container-fluid {
      padding: 0 !important;
      margin: 0 !important;
    }
    .card {
      border: 1px solid #dee2e6 !important;
      box-shadow: none !important;
      page-break-inside: avoid;
    }
    .card-header {
      padding: 0.5rem 0.75rem !important;
      background-color: #f8f9fa !important;
    }
    .card-body {
      padding: 0.75rem !important;
    }
    .card-footer {
      padding: 0.4rem 0.75rem !important;
    }
    body {
      font-size: 9pt;
      line-height: 1.3;
    }
    h1 { font-size: 14pt; margin-bottom: 0.3rem !important; }
    h5 { font-size: 10pt; margin-bottom: 0.4rem !important; margin-top: 0.6rem !important; }
    h6 { font-size: 9pt; margin-bottom: 0.3rem !important; }
    .mb-4, .mb-3, .mb-2 { margin-bottom: 0.5rem !important; }
    .ms-4 { margin-left: 1rem !important; }
    .p-3 { padding: 0.4rem !important; }
    .py-2 { padding-top: 0.3rem !important; padding-bottom: 0.3rem !important; }
    .badge { font-size: 8pt; padding: 0.15rem 0.4rem; }
    .table { font-size: 8pt; }
    .table td, .table th { padding: 0.25rem !important; }
    .text-muted { color: #495057 !important; }
    .bg-light { background-color: #f8f9fa !important; }
    .bg-warning { background-color: #fff3cd !important; }
    .border-warning { border-color: #ffc107 !important; }
    .rounded-3 { border-radius: 0.25rem !important; }
    .alert { 
      padding: 0.4rem 0.6rem !important;
      border: 1px solid #ffc107 !important;
      background-color: #fff3cd !important;
      font-size: 8pt !important;
    }
    .alert strong { font-size: 9pt; }
    .row { margin-bottom: 0.3rem !important; }
  </style>

  <!-- Confidential Notice -->
  <div class="alert alert-warning border-warning rounded-3 d-flex align-items-center gap-2 mb-4 py-2 mt-4" role="alert">
    <div class="bg-warning bg-opacity-25 rounded-circle p-2">
      <i class="bi bi-shield-lock fs-5 text-warning"></i>
    </div>
    <div class="flex-grow-1">
      <strong class="d-block mb-0">
        <i class="bi bi-eye-slash me-1"></i>{% translate "Internal View" %}
      </strong>
      <small class="text-muted">{% translate "Internal view, some of the information on the services might be intended for internal purposes only!" %}</small>
    </div>    <a href="?view=public{% if from_page %}&from={{ from_page }}{% endif %}" class="btn btn-sm btn-outline-secondary no-print" title="{% translate 'Switch to public view' %}">
      <i class="bi bi-eye me-1"></i>{% translate "Public view" %}
    </a>  </div>

  <!-- Navigation -->
  <div class="mb-3 no-print">
    {% if from_page == 'jump' %}
      <a href="{% url 'services_jump' %}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>{% translate "Back to Online Services" %}
      </a>
    {% elif from_page == 'catalogue' %}
      <a href="{% url 'services_listed' %}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>{% translate "Back to Service Catalogue" %}
      </a>
    {% else %}
      <a href="{% url 'services_available' %}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>{% translate "Back to Service Catalogue" %}
      </a>
    {% endif %}
    <button onclick="window.print()" class="btn btn-sm btn-outline-primary ms-2">
      <i class="bi bi-printer me-1"></i>{% translate "Print" %}
    </button>
  </div>

  <!-- Service Detail Card -->
  <div class="card border-0 shadow-sm">
    <div class="card-header bg-white border-bottom">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <h1 class="h3 mb-2">{{ sr.service.name }}</h1>
          <div class="text-muted">
            <span class="badge bg-primary me-2">{{ sr.key }}</span>
            {% if sr.available_from and sr.available_from <= today %}
              {% if not sr.available_until or sr.available_until >= today %}
                {% if not sr.listed_from or sr.listed_from > today %}
                <span class="badge bg-warning text-dark me-2" title="{% translate 'This service is available but not publicly listed in the service catalogue.' %}">
                  <i class="bi bi-eye-slash me-1"></i>{% translate "not publicly listed" %}
                </span>
                {% elif sr.listed_until and sr.listed_until < today %}
                <span class="badge bg-warning text-dark me-2" title="{% translate 'This service is available but not publicly listed in the service catalogue.' %}">
                  <i class="bi bi-eye-slash me-1"></i>{% translate "not publicly listed" %}
                </span>
                {% endif %}
              {% endif %}
            {% endif %}
            <span><i class="bi bi-folder me-1"></i>{{ sr.service.category.name }}</span>
            <span class="ms-2"><i class="bi bi-tag me-1"></i>{% translate "Version" %} {{ sr.version }}</span>
          </div>
          {% if show_keywords and sr.keywords %}
          <div class="mt-2">
            <small class="text-secondary">
              <i class="bi bi-search me-1"></i>{% translate "Keywords" %}: {{ sr.keywords }}
            </small>
          </div>
          {% endif %}
        </div>
        {% if user_can_edit_servicerevisions %}
        <a class="btn btn-sm btn-outline-secondary no-print" href="{% url 'admin:ServiceCatalogue_servicerevision_change' sr.id %}" target="_blank" title="{% translate 'Edit in admin' %}">
          <i class="bi bi-pencil-square me-1"></i>{% translate "Edit" %}
        </a>
        {% endif %}
      </div>
    </div>

    <div class="card-body p-4">
      <!-- Main Purpose -->
      <div class="mb-4">
        <h5 class="text-primary fw-semibold mb-3 d-flex align-items-center gap-2">
          <i class="bi bi-bullseye"></i>
          {% translate "Main purpose" %}
          {% if user_can_edit_services %}
          <a class="text-decoration-none text-secondary small no-print" href="{% url 'admin:ServiceCatalogue_service_change' sr.service.id %}" target="_blank" title="{% translate 'Edit' %}">
            <i class="bi bi-pencil"></i>
          </a>
          {% endif %}
        </h5>
        <div class="ms-4">{{ sr.service.purpose|linebreaks }}</div>
      </div>

      <!-- Internal Description (Staff Only) -->
      {% if sr.description_internal %}
      <div class="mb-4">
        <h5 class="text-warning fw-semibold mb-3 d-flex align-items-center gap-2">
          <i class="bi bi-lock-fill"></i>
          {% translate "Internal description / configuration" %}
        </h5>
        <div class="ms-4 p-3 bg-warning bg-opacity-10 border border-warning rounded-3">
          {{ sr.description_internal|linebreaks|urlize|parse_simple_markdown|parse_internal_links_detail }}
        </div>
      </div>
      {% endif %}

      <!-- Public Description -->
      <div class="mb-4">
        <h5 class="text-primary fw-semibold mb-3 d-flex align-items-center gap-2">
          <i class="bi bi-info-circle"></i>
          {% translate "Description" %}
        </h5>
        <div class="ms-4">{{ sr.description|linebreaks|parse_internal_links_detail }}</div>
      </div>

      <!-- Usage Information / Please Note -->
      {% if show_usage_information and sr.usage_information %}
      <div class="mb-4">
        <div class="ms-4 p-3 bg-danger bg-opacity-10 border border-danger border-opacity-75 rounded-3 d-flex gap-3">
          <div class="flex-shrink-0 text-danger" style="line-height: 1.5;">
            <i class="bi bi-exclamation-circle"></i>
          </div>
          <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <p class="fw-bold mb-0">{% translate "Please Note" %}:</p>
            </div>
            <div>{{ sr.usage_information|linebreaks|urlize|parse_simple_markdown|parse_internal_links_detail }}</div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Requirements -->
      {% if show_requirements and sr.requirements %}
      <div class="mb-4">
        <h5 class="text-primary fw-semibold mb-3 d-flex align-items-center gap-2">
          <i class="bi bi-check2-square"></i>
          {% translate "Requirements" %}
        </h5>
        <div class="ms-4">{{ sr.requirements|linebreaks|urlize|parse_simple_markdown|parse_internal_links_detail }}</div>
      </div>
      {% endif %}

      <!-- Details -->
      {% if show_details and sr.details %}
      <div class="mb-4">
        <h5 class="text-primary fw-semibold mb-3 d-flex align-items-center gap-2">
          <i class="bi bi-list-check"></i>
          {% translate "Details" %}
        </h5>
        <div class="ms-4">{{ sr.details|linebreaks|urlize|parse_simple_markdown|parse_internal_links_detail }}</div>
      </div>
      {% endif %}

      <!-- Options -->
      {% if show_options and sr.options %}
      <div class="mb-4">
        <h5 class="text-primary fw-semibold mb-3 d-flex align-items-center gap-2">
          <i class="bi bi-sliders"></i>
          {% translate "Options" %}
        </h5>
        <div class="ms-4">{{ sr.options|linebreaks|urlize|parse_simple_markdown|parse_internal_links_detail }}</div>
      </div>
      {% endif %}

      <!-- Service Level -->
      {% if show_service_level and sr.service_level %}
      <div class="mb-4">
        <h5 class="text-primary fw-semibold mb-3 d-flex align-items-center gap-2">
          <i class="bi bi-graph-up-arrow"></i>
          {% translate "Service Level" %}
        </h5>
        <div class="ms-4">{{ sr.service_level|linebreaks|urlize|parse_simple_markdown|parse_internal_links_detail }}</div>
      </div>
      {% endif %}

      <!-- Service URL -->
      {% if sr.url %}
      <div class="mb-4">
        <h5 class="text-primary fw-semibold mb-3 d-flex align-items-center gap-2">
          <i class="bi bi-link-45deg"></i>
          {% translate "Link to service" %}
        </h5>
        <div class="ms-4">
          <a href="{{ sr.url }}" class="btn btn-primary" target="_blank">
            <i class="bi bi-box-arrow-up-right me-1"></i>{% translate "Open service" %}
          </a>
          <div class="text-muted small mt-2">{{ sr.url }}</div>
        </div>
      </div>
      {% endif %}

      <!-- Contact -->
      {% if sr.contact %}
      <div class="mb-4">
        <h5 class="text-primary fw-semibold mb-3 d-flex align-items-center gap-2">
          <i class="bi bi-envelope"></i>
          {% translate "Service contact" %}
        </h5>
        <div class="ms-4">
          <a href="mailto:{{ sr.contact }}" class="btn btn-outline-primary">
            <i class="bi bi-envelope me-1"></i>{{ sr.contact }}
          </a>
        </div>
      </div>
      {% endif %}

      <hr class="my-4">

      <!-- Organizational Information -->
      <h5 class="text-primary mb-4 fw-semibold">
        <i class="bi bi-diagram-3 me-2"></i>{% translate "Organizational Information" %}
      </h5>

      <div class="row g-3 mb-4">
        <div class="col-md-6">
          <div class="p-3 bg-light rounded-3">
            <div class="d-flex align-items-start gap-2">
              <i class="bi bi-building text-muted"></i>
              <div class="flex-grow-1">
                <small class="text-muted d-block mb-1">{% translate "Involved unit(s)" %}</small>
                <div class="fw-semibold">
                  {% for sp in sr.service.service_providers.all %}
                    {{sp.name}}{% if sp.acronym %} ({{sp.acronym}}){% endif %}{% if not forloop.last %}, {% endif %}
                  {% empty %}
                    <span class="text-muted">{% translate "not yet specified" %}</span>
                  {% endfor %}
                </div>
              </div>
              {% if user_can_edit_services %}
              <a class="text-decoration-none text-secondary small no-print" href="{% url 'admin:ServiceCatalogue_service_change' sr.service.id %}" target="_blank" title="{% translate 'Edit' %}">
                <i class="bi bi-pencil"></i>
              </a>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="p-3 bg-light rounded-3">
            <div class="d-flex align-items-start gap-2">
              <i class="bi bi-person-badge text-muted"></i>
              <div class="flex-grow-1">
                <small class="text-muted d-block mb-1">{% translate "Service owner(s)" %}</small>
                <div class="fw-semibold">
                  {{ sr.service.responsible |default:"?"}} // {{ sr.service.category.responsible |default:"?" }}
                </div>
              </div>
              {% if user_can_edit_services %}
              <a class="text-decoration-none text-secondary small no-print" href="{% url 'admin:ServiceCatalogue_service_change' sr.service.id %}" target="_blank" title="{% translate 'Edit' %}">
                <i class="bi bi-pencil"></i>
              </a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Timeline Information -->
      <h5 class="text-primary mb-4 fw-semibold">
        <i class="bi bi-calendar-range me-2"></i>{% translate "Timeline & Availability" %}
      </h5>

      <div class="row g-3 mb-4">
        <div class="col-md-6">
          <div class="p-3 bg-light rounded-3">
            <div class="d-flex align-items-start gap-2">
              <i class="bi bi-eye text-muted"></i>
              <div class="flex-grow-1">
                <small class="text-muted d-block mb-1">{% translate "Listing" %}</small>
                <div class="fw-semibold">
                  {% if sr.listed_from %}
                    {{ sr.listed_from }} - {{ sr.listed_until|default:"∞" }}
                    {% if sr.listed_from > today %}
                      <span class="badge bg-warning text-dark ms-2">{% translate "not yet listed" %}</span>
                    {% elif sr.listed_until and sr.listed_until < today %}
                      <span class="badge bg-secondary ms-2">{% translate "unlisted" %}</span>
                    {% else %}
                      <span class="badge bg-success ms-2">{% translate "listed" %}</span>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">{% translate "not yet scheduled" %}</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="p-3 bg-light rounded-3">
            <div class="d-flex align-items-start gap-2">
              <i class="bi bi-check-circle text-muted"></i>
              <div class="flex-grow-1">
                <small class="text-muted d-block mb-1">{% translate "Availablity" %}</small>
                <div class="fw-semibold">
                  {% if sr.available_from %}
                    {{ sr.available_from }} - {{ sr.available_until|default:"∞" }}
                    {% if sr.available_from > today %}
                      <span class="badge bg-info ms-2">{% translate "upcoming" %}</span>
                    {% elif sr.available_until and sr.available_until < today %}
                      <span class="badge bg-secondary ms-2">{% translate "retired" %}</span>
                    {% else %}
                      <span class="badge bg-success ms-2">{% translate "available" %}</span>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">{% translate "not yet scheduled" %}</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- EOL Action -->
      {% if sr.eol %}
      <div class="mb-4">
        <h6 class="text-primary fw-semibold mb-2 d-flex align-items-center gap-2">
          <i class="bi bi-archive"></i>
          {% translate "EOL action" %}
        </h6>
        <div class="ms-4 p-3 bg-light rounded-3">{{ sr.eol|linebreaks|urlize|parse_simple_markdown|parse_internal_links_detail }}</div>
      </div>
      {% endif %}

      <hr class="my-4">

      <!-- Availability -->
      {% if sr.availability_set.all %}
      <div class="mb-4">
        <h5 class="text-primary fw-semibold mb-3 d-flex align-items-center gap-2">
          <i class="bi bi-people"></i>
          {% translate "Availability" %}
        </h5>
        <div class="ms-4">
          <div class="table-responsive">
            <table class="table table-sm table-hover">
              <thead class="table-light">
                <tr>
                  <th>{% translate "User group" %}</th>
                  <th>{% translate "Fee" %}</th>
                  <th>{% translate "Comment" %}</th>
                </tr>
              </thead>
              <tbody>
                {% for avail in sr.availability_set.all %}
                <tr>
                  <td>{{ avail.clientele.name }}</td>
                  <td>
                    {% if avail.fee > 0 %}
                      <span class="badge bg-warning">{{ avail.fee }} {% if avail.fee_unit %}{{ avail.fee_unit.name }}{% endif %}</span>
                    {% else %}
                      <span class="badge bg-success">{% translate "Free" %}</span>
                    {% endif %}
                  </td>
                  <td class="small text-muted">{{ avail.comment|default:"-" }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Submission Status -->
      <div class="mb-4">
        <h5 class="text-primary fw-semibold mb-3 d-flex align-items-center gap-2">
          <i class="bi bi-file-earmark-check"></i>
          {% translate "Status" %}
        </h5>
        <div class="ms-4">
          <div class="row g-3">
            <div class="col-md-6">
              <div class="small text-muted">{% translate "Submitted for publication" %}</div>
              <div>
                {% if sr.submitted %}
                  <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>{% translate "Yes" %}</span>
                {% else %}
                  <span class="badge bg-secondary"><i class="bi bi-x-circle me-1"></i>{% translate "No" %}</span>
                {% endif %}
              </div>
            </div>
            <div class="col-md-6">
              <div class="small text-muted">{% translate "Version" %}</div>
              <div><span class="badge bg-info">{{ sr.version }}</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="card-footer bg-light text-muted small">
      <div class="d-flex justify-content-between align-items-center">
        <span>
          <i class="bi bi-building me-1"></i>{{ organization_name }} - {% translate "Internal View" %}
        </span>
        <span class="no-print">
          {% translate "Last updated" %}: {{ today }}
        </span>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <div class="mt-3 mb-4 no-print">
    {% if from_page == 'jump' %}
      <a href="{% url 'services_jump' %}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>{% translate "Back to Online Services" %}
      </a>
    {% elif from_page == 'catalogue' %}
      <a href="{% url 'services_listed' %}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>{% translate "Back to Service Catalogue" %}
      </a>
    {% else %}
      <a href="{% url 'services_available' %}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>{% translate "Back to Service Catalogue" %}
      </a>
    {% endif %}
  </div>
</div>
{% endblock %}
