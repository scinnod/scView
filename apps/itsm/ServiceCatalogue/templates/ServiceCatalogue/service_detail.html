{% extends "ServiceCatalogue/services_base.html" %}

{% load i18n %}
{% load html_links %}

{% block title %}{{ sr.service.name }} - {{ sr.key }}{% endblock %}

{% block bodycontent %}
<div class="container-fluid px-0">
  <!-- Print styles -->
  <style media="print">
    @page {
      size: A4;
      margin: 1.5cm;
    }
    .no-print {
      display: none !important;
    }
    .container-fluid {
      padding: 0 !important;
      margin: 0 !important;
    }
    .card {
      border: 1px solid #dee2e6 !important;
      box-shadow: none !important;
      page-break-inside: avoid;
    }
    .card-header {
      padding: 0.5rem 0.75rem !important;
      background-color: #f8f9fa !important;
    }
    .card-body {
      padding: 0.75rem !important;
    }
    .card-footer {
      padding: 0.4rem 0.75rem !important;
    }
    body {
      font-size: 9pt;
      line-height: 1.3;
    }
    h1 { font-size: 14pt; margin-bottom: 0.3rem !important; }
    h5 { font-size: 10pt; margin-bottom: 0.4rem !important; margin-top: 0.6rem !important; }
    h6 { font-size: 9pt; margin-bottom: 0.3rem !important; }
    .mb-4, .mb-3 { margin-bottom: 0.5rem !important; }
    .ms-4 { margin-left: 1rem !important; }
    .p-3 { padding: 0.4rem !important; }
    .badge { font-size: 8pt; padding: 0.15rem 0.4rem; }
    .table { font-size: 8pt; }
    .table td, .table th { padding: 0.25rem !important; }
    .text-muted { color: #495057 !important; }
    .bg-light { background-color: #f8f9fa !important; }
    .rounded-3 { border-radius: 0.25rem !important; }
    .row { margin-bottom: 0.3rem !important; }
  </style>

  {% if user.is_staff %}
  <!-- Staff Notice - Public View -->
  <div class="alert alert-info border-info rounded-3 d-flex align-items-center gap-2 mb-4 py-2 mt-4 no-print" role="alert">
    <div class="bg-info bg-opacity-25 rounded-circle p-2">
      <i class="bi bi-eye fs-5 text-info"></i>
    </div>
    <div class="flex-grow-1">
      <strong class="d-block mb-0">
        <i class="bi bi-people me-1"></i>{% translate "Public View" %}
      </strong>
      <small class="text-muted">{% translate "You are viewing this page as a regular user would see it." %}</small>
    </div>
    <a href="?view=internal{% if from_page %}&from={{ from_page }}{% endif %}" class="btn btn-sm btn-outline-secondary" title="{% translate 'Switch to internal view' %}">
      <i class="bi bi-shield-lock me-1"></i>{% translate "Internal view" %}
    </a>
  </div>
  {% endif %}

  <!-- Navigation -->
  <div class="mb-3 no-print">
    {% if from_page == 'jump' %}
      <a href="{% url 'services_jump' %}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>{% translate "Back to Online Services" %}
      </a>
    {% elif from_page == 'catalogue' %}
      <a href="{% url 'services_listed' %}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>{% translate "Back to Service Catalogue" %}
      </a>
    {% else %}
      <a href="{% url 'services_listed' %}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>{% translate "Back to Service Catalogue" %}
      </a>
    {% endif %}
    <button onclick="window.print()" class="btn btn-sm btn-outline-primary ms-2">
      <i class="bi bi-printer me-1"></i>{% translate "Print" %}
    </button>
  </div>

  <!-- Service Detail Card -->
  <div class="card border-0 shadow-sm">
    <div class="card-header bg-white border-bottom">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <h1 class="h3 mb-2">{{ sr.service.name }}</h1>
          <div class="text-muted">
            <span class="badge bg-primary me-2">{{ sr.key }}</span>
            <span><i class="bi bi-folder me-1"></i>{{ sr.service.category.name }}</span>
            <span class="ms-2"><i class="bi bi-tag me-1"></i>{% translate "Version" %} {{ sr.version }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="card-body p-4">
      <!-- Main Purpose -->
      <div class="mb-4">
        <h5 class="text-primary fw-semibold mb-3 d-flex align-items-center gap-2">
          <i class="bi bi-bullseye"></i>
          {% translate "Main purpose" %}
        </h5>
        <div class="ms-4">{{ sr.service.purpose|linebreaks|parse_internal_links_detail }}</div>
      </div>

      <!-- Description -->
      <div class="mb-4">
        <h5 class="text-primary fw-semibold mb-3 d-flex align-items-center gap-2">
          <i class="bi bi-info-circle"></i>
          {% translate "Description" %}
        </h5>
        <div class="ms-4">{{ sr.description|linebreaks|parse_internal_links_detail }}</div>
      </div>

      <!-- Usage Information / Please Note -->
      {% if show_usage_information and sr.usage_information %}
      <div class="mb-4">
        <div class="ms-4 p-3 bg-danger bg-opacity-10 border border-danger border-opacity-75 rounded-3 d-flex gap-3">
          <div class="flex-shrink-0 text-danger" style="line-height: 1.5;">
            <i class="bi bi-exclamation-circle"></i>
          </div>
          <div class="flex-grow-1">
            <p class="fw-bold mb-0">{% translate "Please Note" %}:</p>
            <div>{{ sr.usage_information|linebreaks|urlize|parse_internal_links_detail }}</div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Requirements -->
      {% if show_requirements and sr.requirements %}
      <div class="mb-4">
        <h5 class="text-primary fw-semibold mb-3 d-flex align-items-center gap-2">
          <i class="bi bi-check2-square"></i>
          {% translate "Requirements" %}
        </h5>
        <div class="ms-4">{{ sr.requirements|linebreaks|parse_internal_links_detail }}</div>
      </div>
      {% endif %}

      <!-- Details -->
      {% if show_details and sr.details %}
      <div class="mb-4">
        <h5 class="text-primary fw-semibold mb-3 d-flex align-items-center gap-2">
          <i class="bi bi-list-check"></i>
          {% translate "Details" %}
        </h5>
        <div class="ms-4">{{ sr.details|linebreaks|urlize|parse_internal_links_detail }}</div>
      </div>
      {% endif %}

      <!-- Options -->
      {% if show_options and sr.options %}
      <div class="mb-4">
        <h5 class="text-primary fw-semibold mb-3 d-flex align-items-center gap-2">
          <i class="bi bi-sliders"></i>
          {% translate "Options" %}
        </h5>
        <div class="ms-4">{{ sr.options|linebreaks|parse_internal_links_detail }}</div>
      </div>
      {% endif %}

      <!-- Service Level -->
      {% if show_service_level and sr.service_level %}
      <div class="mb-4">
        <h5 class="text-primary fw-semibold mb-3 d-flex align-items-center gap-2">
          <i class="bi bi-graph-up-arrow"></i>
          {% translate "Service Level" %}
        </h5>
        <div class="ms-4">{{ sr.service_level|linebreaks|parse_internal_links_detail }}</div>
      </div>
      {% endif %}

      <!-- Service URL -->
      {% if sr.url %}
      <div class="mb-4">
        <h5 class="text-primary fw-semibold mb-3 d-flex align-items-center gap-2">
          <i class="bi bi-link-45deg"></i>
          {% translate "Link to service" %}
        </h5>
        <div class="ms-4">
          <a href="{{ sr.url }}" class="btn btn-primary" target="_blank">
            <i class="bi bi-box-arrow-up-right me-1"></i>{% translate "Open service" %}
          </a>
          <div class="text-muted small mt-2">{{ sr.url }}</div>
        </div>
      </div>
      {% endif %}

      <!-- Contact -->
      {% if sr.contact %}
      <div class="mb-4">
        <h5 class="text-primary fw-semibold mb-3 d-flex align-items-center gap-2">
          <i class="bi bi-envelope"></i>
          {% translate "Service contact" %}
        </h5>
        <div class="ms-4">
          <a href="mailto:{{ sr.contact }}" class="btn btn-outline-primary">
            <i class="bi bi-envelope me-1"></i>{{ sr.contact }}
          </a>
        </div>
      </div>
      {% endif %}

      <!-- Availability Timeline -->
      {% if sr.available_from > today or not sr.available_from or sr.available_until %}
      <div class="mb-4">
        <h5 class="text-primary fw-semibold mb-3 d-flex align-items-center gap-2">
          <i class="bi bi-calendar-range"></i>
          {% translate "Availability" %}
        </h5>
        <div class="ms-4">
          {% if sr.available_from > today %}
            <span class="badge bg-warning text-dark"><i class="bi bi-clock me-1"></i>{{ sr.available_from }}</span> 
            {% if sr.available_until %}- {{ sr.available_until }}{% endif %}
            <small class="text-muted ms-2">({% translate "not yet available" %})</small>
          {% elif not sr.available_from %}
            <span class="badge bg-secondary"><i class="bi bi-question-circle me-1"></i>{% translate "not yet scheduled" %}</span>
          {% elif sr.available_until %}
            {{ sr.available_from }} - <span class="badge bg-warning text-dark"><i class="bi bi-calendar-x me-1"></i>{{ sr.available_until }}</span>
            <small class="text-muted ms-2">({% translate "end of availability scheduled" %})</small>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <!-- Available for -->
      <div class="mb-4">
        <h5 class="text-primary fw-semibold mb-3 d-flex align-items-center gap-2">
          <i class="bi bi-people"></i>
          {% translate "Available for" %}
        </h5>
        <div class="ms-4">
          {% if show_simple_availability %}
            {# Simple badge view - all free, no comments #}
            <div>
              {% for avail in sr.availability_set.all %}
                <span class="badge bg-light text-dark border me-1 mb-1">{{ avail.clientele_name_with_costs }}</span>
              {% empty %}
                <span class="text-muted"><em>{% translate "unfortunately nobody yet" %}</em></span>
              {% endfor %}
            </div>
          {% else %}
            {# Detailed table view - has costs or comments #}
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>{% translate "User group" %}</th>
                    <th>{% translate "Fee" %}</th>
                  </tr>
                </thead>
                <tbody>
                  {% for avail in sr.availability_set.all %}
                  <tr>
                    <td>{{ avail.clientele.name }}</td>
                    <td>
                      {% if avail.fee > 0 %}
                        {{ avail.fee }} {% if avail.fee_unit %}{{ avail.fee_unit.name }}{% endif %}
                      {% else %}
                        <span class="text-success">{% translate "Free" %}</span>
                      {% endif %}
                      {% if avail.comment %}
                        <div class="text-muted small">{{ avail.comment }}</div>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Service Lifecycle -->
      {% if sr.available_from or sr.available_until %}
      <div class="mb-4">
        <h5 class="text-primary fw-semibold mb-3 d-flex align-items-center gap-2">
          <i class="bi bi-calendar-event"></i>
          {% translate "Service lifecycle" %}
        </h5>
        <div class="ms-4">
          <div class="row g-3">
            {% if sr.available_from %}
            <div class="col-md-6">
              <div class="small text-muted">{% translate "Available from" %}</div>
              <div>{{ sr.available_from }}</div>
            </div>
            {% endif %}
            {% if sr.available_until %}
            <div class="col-md-6">
              <div class="small text-muted">{% translate "Available until" %}</div>
              <div class="text-warning">{{ sr.available_until }}</div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Footer -->
    <div class="card-footer bg-light text-muted small">
      <div class="d-flex justify-content-between align-items-center">
        <span>
          <i class="bi bi-building me-1"></i>{{ organization_name }}
        </span>
        <span class="no-print">
          {% translate "Last updated" %}: {{ today }}
        </span>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <div class="mt-3 mb-4 no-print">
    {% if from_page == 'jump' %}
      <a href="{% url 'services_jump' %}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>{% translate "Back to Online Services" %}
      </a>
    {% else %}
      <a href="{% url 'services_listed' %}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>{% translate "Back to Service Catalogue" %}
      </a>
    {% endif %}
  </div>
</div>
{% endblock %}
